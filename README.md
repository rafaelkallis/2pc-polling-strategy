## Two Phase Commit
### by [Rafael Kallis](http://rafaelkallis.com), [Elias Bernhaut](https://github.com/alpox)
[![Build Status](https://travis-ci.org/rafaelkallis/2pc-polling-strategy.svg?branch=master)](https://travis-ci.org/rafaelkallis/2pc-polling-strategy)
___
 
 ## Problem Definition

 Unlike a transaction on a local database, a distributed transaction involves altering data on multiple databases. Consequently, distributed transaction processing is more complicated, because the database must coordinate the committing or aborting the changes in a transaction as a self-contained unit. In other words, the entire transaction commits, or the entire transaction aborts.

 ---

 ## Two Phase Commit Protocol
  
The database ensures the integrity of data in a distributed transaction using the two-phase commit mechanism. In the prepare phase, the coordinator in the transaction asks the subordinates to promise to commit or abort the transaction. If all subordinates are able to commit the transaction, the transaction stages in the commit phase, otherwise it stages in the abort phase. During the commit phase, the coordinator asks all subordinates to commit the transaction. During the abort phase, all subordinates are asked to abort. You can view an illustration of the protocol below.

### Protocol Diagram

<div style="width: 100%; text-align: center;">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="473px" height="363px" version="1.1"><defs/><g transform="translate(0.5,0.5)"><rect x="1" y="1" width="470" height="360" rx="54" ry="54" fill="#ffffff" stroke="#33001a" pointer-events="none"/><rect x="81" y="24" width="100" height="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><path d="M 131 64 L 131 324" fill="none" stroke="#33001a" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(99.5,38.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="63" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 64px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Coordinator</div></div></foreignObject><text x="32" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Coordinator</text></switch></g><rect x="281" y="24" width="100" height="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><path d="M 331 64 L 331 324" fill="none" stroke="#33001a" stroke-miterlimit="10" stroke-dasharray="3 3" pointer-events="none"/><g transform="translate(298.5,38.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">Subordinate</div></div></foreignObject><text x="33" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">Subordinate</text></switch></g><path d="M 141 94 L 313.08 132.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 319.91 133.76 L 312.32 135.66 L 313.83 128.82 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(200.5,89.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="52" height="11" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">PREPARE</div></div></foreignObject><text x="26" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">PREPARE</text></switch></g><path d="M 321 144 L 148.92 182.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 142.09 183.76 L 148.17 178.82 L 149.68 185.66 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(184.5,139.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="81" height="11" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">YES / NO VOTE</div></div></foreignObject><text x="41" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">YES / NO VOTE</text></switch></g><path d="M 141 204 L 312.99 232.67" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 319.9 233.82 L 312.42 236.12 L 313.57 229.21 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(185.5,189.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="91" height="11" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">COMMIT / ABORT</div></div></foreignObject><text x="46" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">COMMIT / ABORT</text></switch></g><path d="M 321 245 L 148.92 283.24" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 142.09 284.76 L 148.17 279.82 L 149.68 286.66 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(218.5,240.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="23" height="11" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">ACK</div></div></foreignObject><text x="12" y="11" fill="#000000" text-anchor="middle" font-size="11px" font-family="Helvetica">ACK</text></switch></g><g transform="translate(26.5,187.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="85" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">commit* / abort*</div></div></foreignObject><text x="43" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">commit* / abort*</text></switch></g><g transform="translate(342.5,131.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="88" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">prepare* / abort*</div></div></foreignObject><text x="44" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">prepare* / abort*</text></switch></g><g transform="translate(342.5,228.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="85" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">commit* / abort*</div></div></foreignObject><text x="43" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">commit* / abort*</text></switch></g></g></svg>
</div>

##### An * next to the record type means that the record is forced to stable storage.


We assume that each tranaction runs through a different instance of the state charts below. When the transaction starts, the coordinator sends *prepare* messages to all subordinates. The coordinator awaits all subordinates to respond with their votes. If all subordinates responded with a *yes* vote, the coordinator sends *commit* messages to all subordinates. If any subordinate responded to the *prepare* message with a *no* or a timeout has occured, the coordinator sends *abort* messages to all subordinates. After sending *commit* (*abort*) messages, the coordinator awaits all subordinates to respond with an *ack* message. If a timeout occurres while waiting, the coordinator retransmitts the *commit* (*abort*) message to the respective subordinate. The transaction ends when all subordinates have responded with an *ack* message to the coordinator's *commit* (*abort*) message.

### Coordinator State Chart

<div style="width: 100%; text-align: center;">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="533px" height="433px" version="1.1"><defs/><g transform="translate(0.5,0.5)"><rect x="1" y="1" width="530" height="430" rx="64.5" ry="64.5" fill="#ffffff" stroke="#33001a" pointer-events="none"/><ellipse cx="191" cy="101" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(154.5,87.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="73" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 74px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">PREPARE<div>AWAIT VOTE</div></div></div></foreignObject><text x="37" y="19" fill="#000000" text-anchor="middle" font-size="12px">PREPARE&lt;div&gt;AWAIT VOTE&lt;/div&gt;</text></switch></g><path d="M 191 141 L 191 184.63" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 191 189.88 L 187.5 182.88 L 191 184.63 L 194.5 182.88 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(98.5,148.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="85" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">YES /<div>SEND COMMIT</div></div></div></foreignObject><text x="43" y="19" fill="#000000" text-anchor="middle" font-size="12px">YES /&lt;div&gt;SEND COMMIT&lt;/div&gt;</text></switch></g><path d="M 191 271 L 236.18 321.83" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 239.67 325.75 L 232.4 322.85 L 236.18 321.83 L 237.63 318.2 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(175.5,298.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="31" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">ACK /<div>END</div></div></div></foreignObject><text x="16" y="19" fill="#000000" text-anchor="middle" font-size="12px">[Not supported by viewer]</text></switch></g><ellipse cx="191" cy="231" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(158.5,217.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">COMMIT<div>AWAIT ACK</div></div></div></foreignObject><text x="33" y="19" fill="#000000" text-anchor="middle" font-size="12px">COMMIT&lt;div&gt;AWAIT ACK&lt;/div&gt;</text></switch></g><path d="M 346 271 L 304.22 321.14" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 300.85 325.17 L 302.65 317.56 L 304.22 321.14 L 308.02 322.04 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(330.5,297.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="31" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">ACK /<div>END</div></div></div></foreignObject><text x="16" y="19" fill="#000000" text-anchor="middle" font-size="12px">[Not supported by viewer]</text></switch></g><ellipse cx="346" cy="231" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(313.5,217.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">ABORT<div>AWAIT ACK</div></div></div></foreignObject><text x="33" y="19" fill="#000000" text-anchor="middle" font-size="12px">ABORT&lt;div&gt;AWAIT ACK&lt;/div&gt;</text></switch></g><path d="M 228.36 132.3 L 303.79 195.59" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 307.81 198.97 L 300.2 197.15 L 303.79 195.59 L 304.7 191.79 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(271.5,138.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="78" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">TIMEOUT &or; NO / <div>SEND ABORT</div></div></div></foreignObject><text x="39" y="19" fill="#000000" text-anchor="middle" font-size="12px">NO /&amp;nbsp;&lt;div&gt;SEND ABORT&lt;/div&gt;</text></switch></g><path d="M 91 36 L 142.7 69.61" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 147.1 72.47 L 139.33 71.59 L 142.7 69.61 L 143.14 65.72 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(114.5,17.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="93" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">START /<div>SEND PREPARE</div></div></div></foreignObject><text x="47" y="19" fill="#000000" text-anchor="middle" font-size="12px">START /&lt;div&gt;SEND PREPARE&lt;/div&gt;</text></switch></g><path d="M 149 259 Q 71 259 71 234 Q 71 209 134.52 209" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 139.77 209 L 132.77 212.5 L 134.52 209 L 132.77 205.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(25.5,258.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="92" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">TIMEOUT / <div>RETRY COMMIT</div></div></div></foreignObject><text x="46" y="19" fill="#000000" text-anchor="middle" font-size="12px">TIMEOUT /&amp;nbsp;&lt;div&gt;RETRY COMMIT&lt;/div&gt;</text></switch></g><path d="M 388 259 Q 471 259 471 231 Q 471 203 394.37 203" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 389.12 203 L 396.12 199.5 L 394.37 203 L 396.12 206.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(431.5,258.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="78" height="24" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 11px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">TIMEOUT /<div>RETRY ABORT</div></div></div></foreignObject><text x="39" y="18" fill="#000000" text-anchor="middle" font-size="11px">TIMEOUT /&lt;div&gt;RETRY ABORT&lt;/div&gt;</text></switch></g><ellipse cx="271" cy="361" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(258.5,354.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="25" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 26px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">END</div></div></foreignObject><text x="13" y="12" fill="#000000" text-anchor="middle" font-size="12px">END</text></switch></g></g></svg>
</div>

### Subordinate State Chart

<div style="text-align: center; width: 100%;">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" width="513px" height="473px" version="1.1"><defs/><g transform="translate(0.5,0.5)"><rect x="1" y="1" width="510" height="470" rx="70.5" ry="70.5" fill="#ffffff" stroke="#33001a" pointer-events="none"/><path d="M 283 129 L 259.31 186.54" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 257.31 191.39 L 256.74 183.59 L 259.31 186.54 L 263.21 186.25 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><ellipse cx="241" cy="101" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(206.5,80.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="68" height="40" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 69px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">CHECKING<div>ABILITY</div><div>TO COMMIT</div></div></div></foreignObject><text x="34" y="26" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 199 129 L 222.69 186.54" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 224.69 191.39 L 218.79 186.25 L 222.69 186.54 L 225.26 183.59 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(86.5,148.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="109" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">ABLE TO COMMIT /<div>SEND YES VOTE</div></div></div></foreignObject><text x="55" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">ABLE TO COMMIT /&lt;div&gt;SEND YES VOTE&lt;/div&gt;</text></switch></g><path d="M 199 259 L 186.85 354.82" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 186.19 360.03 L 183.6 352.65 L 186.85 354.82 L 190.55 353.53 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(48.5,263.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="138" height="54" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">COMMIT /<div>COMMIT TRANSACTION</div><div>&and;<br /></div><div>SEND ACK</div></div></div></foreignObject><text x="69" y="33" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><ellipse cx="241" cy="231" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(196.5,210.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="89" height="40" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 90px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">AWAIT<div>COORDINATOR</div><div>MESSAGE</div></div></div></foreignObject><text x="45" y="26" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><ellipse cx="331" cy="401" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(301.5,394.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="58" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 59px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">ABORTED</div></div></foreignObject><text x="29" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">ABORTED</text></switch></g><path d="M 283 259 L 315.77 355.95" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 317.45 360.92 L 311.89 355.41 L 315.77 355.95 L 318.53 353.17 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(288.5,148.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="126" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">UNABLE TO COMMT / <div>SEND NO VOTE</div></div></div></foreignObject><text x="63" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">UNABLE TO COMMT /&amp;nbsp;&lt;div&gt;SEND NO VOTE&lt;/div&gt;</text></switch></g><g transform="translate(306.5,264.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="130" height="54" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">ABORT /<div>ABORT TRANSACTION</div><div>&and;<br /><div>SEND ACK</div></div></div></div></foreignObject><text x="65" y="33" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 141 36 L 192.7 69.61" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 197.1 72.47 L 189.33 71.59 L 192.7 69.61 L 193.14 65.72 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(159.5,17.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="162" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">PREPARE /<div>CHECK ABILITY TO COMMIT</div></div></div></foreignObject><text x="81" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">PREPARE /&lt;div&gt;CHECK ABILITY TO COMMIT&lt;/div&gt;</text></switch></g><ellipse cx="181" cy="401" rx="60" ry="40" fill="#ffffff" stroke="#33001a" pointer-events="none"/><g transform="translate(148.5,394.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="65" height="12" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; width: 66px; white-space: nowrap; word-wrap: normal; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;">COMMITED</div></div></foreignObject><text x="33" y="12" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">COMMITED</text></switch></g><path d="M 373 373 Q 431 373 431 387 Q 431 401 397.37 401" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 392.12 401 L 399.12 397.5 L 397.37 401 L 399.12 404.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(435.5,367.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="61" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">ABORT /<div>SEND ACK</div></div></div></foreignObject><text x="31" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g><path d="M 139 373 Q 81 373 81 387 Q 81 401 114.63 401" fill="none" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><path d="M 119.88 401 L 112.88 404.5 L 114.63 401 L 112.88 397.5 Z" fill="#000000" stroke="#000000" stroke-miterlimit="10" pointer-events="none"/><g transform="translate(15.5,367.5)"><switch><foreignObject style="overflow:visible;" pointer-events="all" width="61" height="26" requiredFeatures="http://www.w3.org/TR/SVG11/feature#Extensibility"><div xmlns="http://www.w3.org/1999/xhtml" style="display: inline-block; font-size: 12px; font-family: Helvetica; color: rgb(0, 0, 0); line-height: 1.2; vertical-align: top; white-space: nowrap; text-align: center;"><div xmlns="http://www.w3.org/1999/xhtml" style="display:inline-block;text-align:inherit;text-decoration:inherit;background-color:#ffffff;">COMMIT /<div>SEND ACK</div></div></div></foreignObject><text x="31" y="19" fill="#000000" text-anchor="middle" font-size="12px" font-family="Helvetica">[Not supported by viewer]</text></switch></g></g></svg>
</div>

### Formalisation of the Problem

Let *N* = { 0, 1, ... , n } denote the set of all nodes, which includes the coordinator and all subordinates.

Let n<sub>0</sub> &isin; *N* denote the coordinator.

Let n<sub>i</sub> &isin; *N*, i &ne; 0 denote all subordinates.

Let *T* = { 0, ... , m } denote the set of all transactions 

Let t &isin; T denote a transaction.

Let *S* = { Commit, Abort } denote the set of possible states. Note that the states used here are *independent* from the states used in the state charts above.

Let *&fnof;* : *N* x *T* &rarr; *S* denote the function which maps to a state, given a node and a transaction.

In order to reach a consistent state, following condition must be satisfied:

<div style="font-size: 25px; line-height: 35px; width: 100%;">
<div style="width: 250px; margin: auto;">
&fnof;( n<sub>i</sub>, t ) = &fnof;( n<sub>j</sub>, t )
</div>
</div>

## Proof

---

### (Theorem 1) &fnof;(n<sub>i</sub>, t) = Commit &rArr; &fnof;(n<sub>0</sub>, t) = Commit, i &ne; 0
#### (If a subordinate is in commit state, the coordinator must also be in commit state)

*Proof:* In order for subordinate n<sub>i</sub> to be in commit state,
the coordinator n<sub>0</sub> must have entered the commit state before n<sub>i</sub> and then sent a commit message to n<sub>i</sub>. It is impossible for the coordinator to send a commit message, if he is not in the commit state.

---

### (Theorem 2) &fnof;(n<sub>i</sub>, t) = Abort &rArr; &fnof;(n<sub>0</sub>, t) = Abort, i &ne; 0
#### (If a subordinate is in abort state, the coordinator must also be in abort state)

*Proof:* (Analogus to 1) In order for subordinate n<sub>i</sub> to be in abort state,
the coordinator n<sub>0</sub> must have entered the abort state before n<sub>1</sub> and then sent an abort message to n<sub>1</sub>. It is impossible for the coordinator to send an abort message, if he is not in the abort state.

---

### (Theorem 3) &fnof;(n<sub>0</sub>, t) = Commit &rArr; &fnof;(n<sub>i</sub>, t) = Commit, i &ne; 0

#### (If the coordinator is in commit state, all subordinates must also be in commit state)

*Proof:* If the coordinator n<sub>0</sub> enters commit state, he must send commit messages to all subordinates n<sub>i</sub>. All subordinates must respond to the commit message with an ack message. If the coordinator doesn't receive an ack message from a subordinate after a fixed timeout, the coordinator retransmitts the commit message. Eventually all subordinates will receive the commit message, thus every subordinate n<sub>i</sub> must be in commit state. It is impossible for the coordinator to send any other message than the commit message in the commit phase.

---

### (Theorem 4) &fnof;(n<sub>0</sub>, t) = Abort &rArr; &fnof;(n<sub>i</sub>, t) = Abort, i &ne; 0

#### (If the coordinator is in abort state, all subordinates must also be in abort state)

*Proof:* If the coordinator n<sub>0</sub> enters abort state, he must send abort messages to all subordinates n<sub>i</sub>. All subordinates must respond to the abort message with an ack message. If the coordinator doesn't receive an ack message from a subordinate after a fixed timeout, the coordinator retransmitts the abort message. Eventually all subordinates will receive the abort message, thus every subordinate n<sub>i</sub> must be in abort state. It is impossible for the coordinator to send any other message than the abort message in the abort phase.

---

### (Theorem 5) &fnof;(n<sub>i</sub>, t) = Commit &hArr; &fnof;(n<sub>j</sub>, t) = Commit

#### (If one node is in commit state, then all other nodes must also be in commit state)

*Proof:* We consider 3 possible cases:

*Case 1:* i &ne; j = 0 (n<sub>i</sub> is subordinate, n<sub>j</sub> is coordinator)

As shown in (3), if &fnof;(n<sub>j</sub>, t) = Commit &rArr; &fnof;(n<sub>i</sub>, t), and as shown in (1) if &fnof;(n<sub>i</sub>, t) = Commit &rArr; &fnof;(n<sub>j</sub>, t), thus follows that &fnof;(n<sub>i</sub>, t) = Commit &hArr; &fnof;(n<sub>j</sub>, t) = Commit, for i &ne; j = 0.

*Case 2:* j &ne; i = 0 (n<sub>i</sub> is coordinator, n<sub>j</sub> is subordinate)

As shown in (3), if &fnof;(n<sub>i</sub>, t) = Commit &rArr; &fnof;(n<sub>j</sub>, t), and as shown in (1) if &fnof;(n<sub>j</sub>, t) = Commit &rArr; &fnof;(n<sub>i</sub>, t), thus follows that &fnof;(n<sub>j</sub>, t) = Commit &hArr; &fnof;(n<sub>i</sub>, t) = Commit, for j &ne; i = 0.

*Case 3:* i = j &ne; 0 (both n<sub>i</sub> and n<sub>j</sub> are subordinates)

As shown in (3), if &fnof;(n<sub>i</sub>, t) = Commit &rArr; &fnof;(n<sub>0</sub>, t), and as shown in (1) if &fnof;(n<sub>0</sub>, t) = Commit &rArr; &fnof;(n<sub>j</sub>, t). Intuitively this meens that if subordinate n<sub>i</sub> is in commit state, the coordinator also must be in commit state and thus subordinate j also must be in commit state. Thus follows that &fnof;(n<sub>j</sub>, t) = Commit &hArr; &fnof;(n<sub>i</sub>, t) = Commit, for i = j &ne; 0.

From cases 1,2,3 follows that &fnof;(n<sub>i</sub>, t) = Commit &hArr; &fnof;(n<sub>j</sub>, t) = Commit. Simply put, it means that if a node is in commit state, any other node also must be in commit state for transaction t.

---

### (Theorem 6) &fnof;(n<sub>i</sub>, t) = Abort &hArr; &fnof;(n<sub>j</sub>, t) = Abort

#### (If one node is in abort state, then all other nodes must also be in abort state)

*Proof:* (Analogus to 5) We consider 3 possible cases:

*Case 1:* i &ne; j = 0 (n<sub>i</sub> is subordinate, n<sub>j</sub> is coordinator)

As shown in (3), if &fnof;(n<sub>j</sub>, t) = Abort &rArr; &fnof;(n<sub>i</sub>, t), and as shown in (1) if &fnof;(n<sub>i</sub>, t) = Abort &rArr; &fnof;(n<sub>j</sub>, t), thus follows that &fnof;(n<sub>i</sub>, t) = Abort &hArr; &fnof;(n<sub>j</sub>, t) = Abort, for i &ne; j = 0.

*Case 2:* j &ne; i = 0 (n<sub>i</sub> is coordinator, n<sub>j</sub> is subordinate)

As shown in (3), if &fnof;(n<sub>i</sub>, t) = Abort &rArr; &fnof;(n<sub>j</sub>, t), and as shown in (1) if &fnof;(n<sub>j</sub>, t) = Abort &rArr; &fnof;(n<sub>i</sub>, t), thus follows that &fnof;(n<sub>j</sub>, t) = Abort &hArr; &fnof;(n<sub>i</sub>, t) = Abort, for j &ne; i = 0.

*Case 3:* i = j &ne; 0 (both n<sub>i</sub> and n<sub>j</sub> are subordinates)

As shown in (3), if &fnof;(n<sub>i</sub>, t) = Abort &rArr; &fnof;(n<sub>0</sub>, t), and as shown in (1) if &fnof;(n<sub>0</sub>, t) = Abort &rArr; &fnof;(n<sub>j</sub>, t). Intuitively this meens that if subordinate i is in abort state, the coordinator also must be in abort state and thus subordinate j also must be in abort state. Thus follows that &fnof;(n<sub>j</sub>, t) = Abort &hArr; &fnof;(n<sub>i</sub>, t) = Abort, for i = j &ne; 0.

From cases 1,2,3 follows that &fnof;(n<sub>i</sub>, t) = Abort &hArr; &fnof;(n<sub>j</sub>, t) = Abort. Simply put, it means that if a node is in abort state, any other node also must be in abort state for transaction t.

---

### (Theorem 7) &fnof;( n<sub>i</sub>, t ) = &fnof;( n<sub>j</sub>, t )

#### (all nodes have the same state, consistent state)

*Proof:* As shown in (5) and (6), if any node is in commit (abort) state, then any other node must be in commit (abort) state. Thus follows:

### &fnof;( n<sub>i</sub>, t ) = &fnof;( n<sub>j</sub>, t )

*Proof Complete.*